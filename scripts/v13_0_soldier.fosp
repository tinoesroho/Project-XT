                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             

const uint16[]Pids_AllWeapon={(300),(122),(8),(22),(18),(404),(241),(313),(398),(388),(394),(10),(287),(299),(23),(405),(143),(351),(403),(500),(161),(162),(261),(353),(392),(94),(385),(242),(268),(354),(9),(296),(283),(352),(391),(332),(11),(400),(13),(12),(389),(395),(350),(355),(387),(16),(402),(390),(118),(401),(28),(120),(24),(406),(15),(233),(396),(397),(16),(402),(390),(118),(401),(28),(120),(24),(406),(15),(233),(396),(397),(159),(25),(26),(27),(79),(205),(365),(45),(19),(423),(426),(486),(4),(236),(517),(383),(319),(522),(7),(280),(320),(5),(20),(384),(6),(386),(115),(160),(399),(116),(292),(293),(496),(497),(235),(21),(234),(407)};
const uint16[]Pids_WeaponSmallGuns={(300),(122),(8),(22),(18),(404),(241),(313),(398),(388),(394),(10),(287),(299),(23),(405),(143),(351),(403),(500),(161),(162),(261),(353),(392),(94),(385),(242),(268),(354),(9),(296),(283),(352),(391),(332)};
const uint16[]Pids_WeaponPistols={(300),(122),(8),(22),(18),(404),(241),(313),(398),(388),(394)};
const uint16[]Pids_WeaponRifles={(10),(287),(299),(23),(405),(143),(351),(403),(500),(161),(162),(261),(353),(392)};
const uint16[]Pids_WeaponShotguns={(94),(385),(242),(268),(354)};
const uint16[]Pids_WeaponPistolMachineGun={(9),(296),(283),(352),(391),(332)};
const uint16[]Pids_WeaponBigGuns={(11),(400),(13),(12),(389),(395),(350),(355),(387)};
const uint16[]Pids_WeaponEnergo={(16),(402),(118),(401),(28),(120),(24),(406),(15),(233),(396),(397)};
const uint16[]Pids_WeaponLaser={(16),(402),(118),(401),(28),(120)};
const uint16[]Pids_WeaponPlasma={(24),(406),(15),(233)};
const uint16[]Pids_WeaponPulse={(396),(397)};
const uint16[]Pids_WeaponThrowing={(159),(25),(26),(27),(79),(205),(365),(45),(19),(423),(426),(486)};
const uint16[]Pids_WeaponGrenade={(159),(25),(26),(27)};
const uint16[]Pids_WeaponThrowingOther={(79),(205),(365),(45),(19),(423),(426),(486)};
const uint16[]Pids_WeaponMelee={(4),(236),(517),(383),(319),(522),(7),(280),(320),(5),(20),(384),(6),(386),(115),(160),(399),(116)};
const uint16[]Pids_WeaponCutting={(4),(236),(517),(383),(319),(522)};
const uint16[]Pids_WeaponPricking={(7),(280),(320)};
const uint16[]Pids_WeaponShock={(5),(20),(384),(6),(386),(115)};
const uint16[]Pids_WeaponElectric={(160),(399),(116)};
const uint16[]Pids_WeaponUnarmed={(292),(293),(496),(497),(235),(21),(234),(407)};
const uint16[]Pids_WeaponSpecial={(270),(393),(371),(372),(427),(489),(498),(290),(291),(518),(520),(530),(531),(421),(390)};

const uint16[]Pids_AllArmor={(74),(1),(379),(265),(2),(380),(240),(17),(381),(239),(3),(232),(348),(349),(113),(524)};
const uint16[]Pids_ArmorLight={(74),(1),(379),(265)};
const uint16[]Pids_ArmorMedium={(2),(380),(240),(17),(381),(239)};
const uint16[]Pids_ArmorHeavy={(3),(232),(348),(349)};
const uint16[]Pids_ArmorRobes={(113)};
const uint16[]Pids_ArmorSpecial={(524)};

const uint16[]Pids_AllAmmo={(359),(35),(36),(363),(360),(121),(29),(30),(33),(31),(111),(357),(34),(95),(358),(14),(37),(32),(382),(38),(39),(163),(361),(362)};
const uint16[]Pids_Ammo={(359),(35),(36),(363),(360),(121),(29),(30),(33),(31),(111),(357),(34),(95),(358)};
const uint16[]Pids_AmmoOther={(14),(37),(32),(382),(38),(39),(163),(361),(362)};
const uint16[]Pids_AmmoSpecial={(274)};

const uint16[]Pids_AllDrugs={(40),(48),(49),(109),(144),(260),(273),(525),(106),(124),(125),(310),(311),(469),(53),(87),(110),(259),(71),(81),(103),(378),(424)};
const uint16[]Pids_DrugsPreparations={(40),(48),(49),(109),(144),(260),(273),(525)};
const uint16[]Pids_DrugsAlcohol={(106),(124),(125),(310),(311),(469)};
const uint16[]Pids_Drugs={(53),(87),(110),(259)};
const uint16[]Pids_DrugsOther={(71),(81),(103),(378)};
const uint16[]Pids_DrugsSpecial={(334),(473),(480),(481),(482),(424)};

const uint16[]Pids_MiscExplosions={(51),(85),(544)};
const uint16[]Pids_MiscActiveExplosions={(206),(209),(545),(222)};
const uint16[]Pids_MiscPartsBasic={(98),(92),(127),(271),(272),(276),(277),(278),(284),(285),(286),(318),(416),(542),(532),(534),(475),(535),(536),(537),(538),(50),(449),(539),(541)};
const uint16[]Pids_MiscPartsSelfSpecial={(89),(222),(229),(307),(419),(454),(364),(422),(479),(488)};
const uint16[]Pids_MiscPartsSpecial={(55),(253),(254),(258),(269),(356),(377)};
const uint16[]Pids_MiscPartsBody={(114),(251),(281),(282),(321),(322),(323),(324),(429),(484),(485),(507)};
const uint16[]Pids_MiscAllTools={(75),(77),(84),(308),(410),(411),(412),(47),(91),(408),(409),(428),(440),(289),(297),(543)};
const uint16[]Pids_MiscToolsTech={(75),(77),(84),(308),(410),(411),(412)};
const uint16[]Pids_MiscToolsMediacal={(47),(91),(408),(409),(428),(440)};
const uint16[]Pids_MiscToolsOther={(289),(297),(543)};
const uint16[]Pids_MiscToolsSpecial={(52),(54),(59)};
const uint16[]Pids_MiscOther={(101),(117),(126),(226),(227),(262),(295),(314),(315),(316),(317),(325),(326),(436),(437)};                                                                                                                                              

int FindInArray(int[]&arr,int value)
{
	uint count=arr.length();
	for(uint i=0;i<count;i++)
	{
		if(arr[i]==value)
		return i;
	}
	return-1;
}

bool FindInArray(int[]&arr,int id,int&index)
{
	for(uint i=0;i<arr.length();i++)
	{
		if(id==arr[i])
		{
			index=i;
			return true;
		}
	}
	index=-1;
	return false;
}  

int FindInArray(uint[]&arr,uint value)
{
	uint count=arr.length();
	for(uint i=0;i<count;i++)
	{
		if(arr[i]==value)
		return i;
	}
	return-1;
}

bool FindInArray(uint[]&arr,uint id,int&index)
{
	for(uint i=0;i<arr.length();i++)
	{
		if(id==arr[i])
		{
			index=i;
			return true;
		}
	}
	index=-1;
	return false;
}  

int FindInArray(uint16[]&arr,uint16 value)
{
	uint count=arr.length();
	for(uint i=0;i<count;i++)
	{
		if(arr[i]==value)
		return i;
	}
	return-1;
}  

int FindInArray(uint8[]&arr,uint8 value)
{
	uint count=arr.length();
	for(uint i=0;i<count;i++)
	{
		if(arr[i]==value)
		return i;
	}
	return-1;
}

bool FindInArray(uint8[]&arr,uint8 id,int&index)
{
	for(uint i=0;i<arr.length();i++)
	{
		if(id==arr[i])
		{
			index=i;
			return true;
		}
	}
	index=-1;
	return false;
}  

bool Present(int what,int[]&where)
{
	if(FindInArray(where,what)==-1)
	return false;
	else
	return true;
}

bool Present(uint what,uint[]&where)
{
	if(FindInArray(where,what)==-1)
	return false;
	else
	return true;
}

bool Present(uint16 what,uint16[]&where)
{
	if(FindInArray(where,what)==-1)
	return false;
	else
	return true;
}

void MergeArrays(uint16[]&arrayTo,uint16[]&arrayFrom)
{
	for(uint i=0,l=arrayFrom.length();i<l;i++)
	{
		arrayTo.insertLast(arrayFrom[i]);
	}
}

void MergeArrays(int[]&arrayTo,int[]&arrayFrom)
{
	for(uint i=0,l=arrayFrom.length();i<l;i++)
	{
		arrayTo.insertLast(arrayFrom[i]);
		arrayTo.insertLast(arrayFrom[i]);
	}
}     

bool IsMined(Critter&sapper,Item&item,Critter&miner,int minerMinSkill,uint16[]BadPid)
{
	
	if(!(@miner!=null))
	return false;
	if(!(@sapper!=null))
	return false;
	
	if(!miner.IsSeenBy(sapper))
	return false;
	
	if((miner.StatBase[(5)]+miner.StatBase[(6)]+Random(1,10))/3<7||miner.Skill[(211)]<minerMinSkill)
	{
		for(uint i=0;i<BadPid.length();i++)
		{
			if(item.GetProtoId()==BadPid[i])
			{
				return true;
			}
		}
	}
	return false;
	
}           

bool SearchWeapon(Item@item,uint[]@itemsAllowed)
{
	
	if((@item!=null))
	{
		if((item.GetType()==(3))&&(itemsAllowed.length()>0))
		{
			for(uint i=0;i<itemsAllowed.length();i++)
			{
				if(item.GetProtoId()==itemsAllowed[i])
				{
					return false;
				}
			}
			return true;
		}
		else if((item.GetType()==(3))&&(itemsAllowed.length()<=0))
		{
			return true;
		}
		return false;
	}
	return false;
	
}  

bool SearchWeapon(Item@item)
{
	
	uint[]itemsAllowed;
	return SearchWeapon(item,itemsAllowed);
	
}  

bool EquipmentInspection(Critter&player,uint[]&itemsForbidden)
{
	
	if(player.IsNotValid)
	return false;
	if(!player.IsPlayer())
	return false;
	
	Item@[]items;
	player.GetItems(-1,items);
	return SearchedForbidden(items,itemsForbidden);
	
}  

bool EquipmentInspection(Critter&player,uint16[]&itemsForbidden)
{
	
	return EquipmentInspection(player,itemsForbidden);
	
}  

bool SearchedForbidden(Item@[]items,uint[]@itemsForbidden)
{ 
	
	for(uint it=0;it<items.length();it++)
	{
		for(uint itf=0;itf<itemsForbidden.length();itf++)
		{
			if(!items[it].IsNotValid)
			{
				if(items[it].GetProtoId()==itemsForbidden[itf])
				return true;
			}
		}
	}
	return false;
	
}

import bool AddAttackPlane(Critter&npc,uint priority,uint critId,int minHp)from"npc_planes";
import bool AddAttackPlane(Critter&npc,uint priority,uint critId)from"npc_planes";
import uint EraseAttackPlane(Critter&npc,uint critId)from"npc_planes"; 

uint CurGuardian=5002372;
int GuardDlg=1909;
uint16 GuardX=69,
GuardY=72,
GuardDir=3; 

void _SoldierInit(Critter&soldier,bool firstTime)
{
	
	soldier.ModeBase[(533)]=1;
	soldier.SetEvent((18),"_SoldierGetMessage");
	soldier.SetEvent((32),"_SoldierMined");
	soldier.SetEvent((26),"_GuardianDead");
	soldier.SetEvent((16),"_FriendlyFire");
	soldier.SetEvent((15),"_FriendlyFire");
	soldier.SetEvent((35),"_FriendlyFirePlane");
	
} 

void _SoldierGetMessage(Critter&soldier,Critter&fromCr,int message,int value)
{
	
	if(!soldier.IsLife())
	return;
	if(soldier.Id==fromCr.Id)
	return;
	if(!fromCr.IsSeenBy(soldier))
	return;
	Critter@player=GetCritter(value);
	if(!(@player!=null))
	return;
	if(!player.IsPlayer())
	return;
	if(message==(301))
	{
		AddAttackPlane(soldier,0,player.Id,int(float(player.StatBase[(3)])*1.5));
		
	}
	else if(message==(303))
	{
		AddAttackPlane(soldier,0,player.Id);
	}
	return;
	
}  

void _SoldierMined(Critter&soldier,Critter&dropper,Item&item)
{
	
	if(!soldier.IsNoPlanes())
	return;
	if(!(@dropper!=null))
	return;
	if(!dropper.IsPlayer())
	return;
	if(!dropper.IsLife())
	return; 
	
	if(IsMined(soldier,item,dropper,soldier.StatBase[(1)]*20,Pids_MiscActiveExplosions))
	{
		AddAttackPlane(soldier,0,dropper.Id);
	}
	
}  

void _GuardianDead(Critter&soldier,Critter&guardian,Critter@killer)
{
	
	uint CurMap=0;
	uint16 X=0,Y=0;
	uint8 Dir=0;
	if(!soldier.IsLife())
	return;
	if(guardian.Id==CurGuardian)
	{
		soldier.StatBase[(89)]=(2);
		guardian.StatBase[(89)]=(1);
		CurGuardian=soldier.Id;
		soldier.GetHomePos(CurMap,X,Y,Dir);
		guardian.SetHomePos(X,Y,Dir);
		soldier.SetHomePos(GuardX,GuardY,GuardDir);
		guardian.StatBase[(104)]=soldier.Stat[(104)];
		soldier.StatBase[(104)]=GuardDlg;
		guardian.SetScript("v13_0_soldier@_SoldierInit");
		soldier.SetScript("v13_0_guard@_GuardInit");
	}
	else
	{
		if((@killer!=null))
		AddAttackPlane(soldier,0,killer.Id);
	}
	
}  

int _FriendlyFirePlane(Critter&guardian,NpcPlane&plane,int reason,Critter@some,Item@someItem)
{
	
	if(plane.Type==(1))
	{
		Critter@target=::GetCritter(plane.Attack_TargId);
		if((@target!=null)&&target.StatBase[(89)]==(2)||target.StatBase[(89)]==(1))
		{
			return(2);
		}
	}
	return(0);
	
}   

bool _FriendlyFire(Critter&guardian,Critter&attacker)
{
	
	if(guardian.IsNpc()&&attacker.IsNpc())
	{
		if(guardian.StatBase[(89)]==(2)||guardian.StatBase[(89)]==(1))
		{
			guardian.Wait(5000);
			attacker.Wait(5000);
			if(guardian.CheckEnemyInStack(attacker.Id))
			guardian.EraseEnemyFromStack(attacker.Id);
			if(attacker.CheckEnemyInStack(guardian.Id))
			attacker.EraseEnemyFromStack(guardian.Id);
			EraseAttackPlane(attacker,guardian.Id);
			EraseAttackPlane(guardian,attacker.Id);
			return true;
		}
	}
	return false;
	
}
